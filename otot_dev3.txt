// 20220424_0947_otot_dev3
Another new line added

// #################################### //
// ##### manually set grade level ##### //
// #################################### //
var gradeLevel = "1";  // The order totals sheet for this grade level will be updated.


function getFileIdForFileName(building) {
  //Get the file id of the building order form that was just created
  var FileIterator = DriveApp.getFilesByName(building);
  var fileId;
  while (FileIterator.hasNext()) {
    var file = FileIterator.next();
    if (file.getName() == building) {
      var Sheet = SpreadsheetApp.open(file);
      fileId = file.getId();
      break;
    }
  } //end while
  return fileId;
}

function createTotalsSheetIdArr(totalsSheetsFolderId) {
  const files = totalsSheetsFolderId.getFiles();
  let totalsSheetIdArr = [];
  while (files.hasNext()) {
    const file = files.next();
    totalsSheetIdArr.push(file.getId());
  }

  let totalsSheetNameArr = [];
  totalsSheetIdArr.forEach((val) => {
    let activeFile = DriveApp.getFileById(val);
    totalsSheetNameArr.push(activeFile.getName());
  })

  let totalsSheetSortedByNameIdArr = [];
  totalsSheetNameArr.sort().reverse().forEach((val) => {
    totalsSheetSortedByNameIdArr.push(getFileIdForFileName(val));
  })
  return (totalsSheetSortedByNameIdArr);

}

function createBuildingIdArr(gradeLevelFolderId) {
  const files = gradeLevelFolderId.getFiles();
  let buildingIdArr = [];
  while (files.hasNext()) {
    const file = files.next();
    buildingIdArr.push(file.getId());
  }

  return (buildingIdArr);
}

function createGradeLevelTeacherFolderIdArr() {
  let orderFormFolderNameArr = [
    "Kindergarten",
    "1st Grade",
    "2nd Grade",
    "3rd Grade",
    "4th Grade",
    "5th Grade"
  ];

  let orderFormFolderIdArr = [];

  orderFormFolderNameArr.forEach((val) => {
    orderFormFolderIdArr.push(folderId = DriveApp.getFoldersByName(val).next().getId());
  })
  return(orderFormFolderIdArr);

  // Logger.log("orderFormFolderIdArr: " + orderFormFolderIdArr);
}

function getOrderFormsTotalQtyNeeded(gradeLevel) {

  if (gradeLevel == "K") {
    gradeLevel == 0;
  }

  let gradeLevelTeacherFolderIdArr = createGradeLevelTeacherFolderIdArr();
  Logger.log("gradeLevelTeacherFolderIdArr: " + gradeLevelTeacherFolderIdArr);  

  // let gradeLevelTeacherFolderIdArr = [
  //   "1HJYOQ2jTizBKtA3QbNAXKSEK1qTUwAom", // Kindergarten    
  //   "1MLrxPH3wr7Rra7fCXjFqEGlWhGYrPPYC", // 1st Grade
  //   "184MQIJb-7w9ydDwopwMg1j3hwsq6xkc4", // 2nd Grade
  //   "1b-YLmImPv9rnEI8bqrX3agU5YIKacoqg", // 3rd Grade
  //   "11pw38RY7yJv0fdjstWPJXQA7emQQsW-6", // 4th Grade
  //   "1AxSmufykeaH6dXRKdjSg65-epLMdvFlv"  // 5th Grade
  // ]

  

  let folderIdForGradeLevel = gradeLevelTeacherFolderIdArr[gradeLevel];
  var buildingIdArr = createBuildingIdArr(DriveApp.getFolderById(folderIdForGradeLevel));

  let orderFormsItemsQuantityNeededArr = [];
  let orderFormsItemNumberArr = [];
  let orderFormsQuantityNeededArr = [];

  for (let b = 0; b < (buildingIdArr.length); b++) {

    let ss = SpreadsheetApp.openById(buildingIdArr[b]);
    Logger.log("Getting Quantity Needed for building: " + ss.getName());
    let sheets = ss.getSheets();

    for (let i = 1; i < (sheets.length - 1); i++) {
      let activeSheet = sheets[i];
      data = activeSheet.getDataRange();
      values = data.getValues();
      for (j = 6; j < values.length; j++) {
        if (values[j][4] != "") {
          orderFormsItemNumberArr.push(values[j][0]);
          orderFormsQuantityNeededArr.push(values[j][4]);
        }
      }
    }

  }

  orderFormsItemsQuantityNeededArr.push(orderFormsItemNumberArr);
  orderFormsItemsQuantityNeededArr.push(orderFormsQuantityNeededArr);

  return (orderFormsItemsQuantityNeededArr);
} // end of function

function updateTotalRequested() {
  Logger.log(`Start program to update Order Totals Google sheet for grade level ${gradeLevel}.`)

  let doNothing = "";
  validGradeLevelArr = ["K", "5", "4", "3", "2", "1"];
  if (validGradeLevelArr.includes(gradeLevel)) {
    doNothing = "";
  } else {
    try {
      throw "exit";
    } catch (e) {
      Logger.log("EXITING - FATAL ERROR Invalid gradeLevel: " + gradeLevel);
    }
  }

  let gradeLevelTotalsSheetIdArr = createTotalsSheetIdArr(DriveApp.getFolderById("1HkvDzgiy18eKTn4IVBIWF5bw0BWncPA1"));

  let gradeLevelTemp = "";
  if (gradeLevel == "K") {
    gradeLevelTemp = 0;
  } else if (gradeLevel == "5") {
    gradeLevelTemp = 1;
  } else if (gradeLevel == "4") {
    gradeLevelTemp = 2;
  } else if (gradeLevel == "3") {
    gradeLevelTemp = 3;
  } else if (gradeLevel == "2") {
    gradeLevelTemp = 4;
  } else if (gradeLevel == "1") {
    gradeLevelTemp = 5;
  } else {
    Logger.log("FATAL ERROR: Fall thru setting gradeLevelTemp. Invalid gradeLevel: " + gradeLevel);
    process.exit(0);
  }

  // fileId is the fileID for each grade-level totals sheet
  let fileId = gradeLevelTotalsSheetIdArr[gradeLevelTemp];

  const ss = SpreadsheetApp.openById(fileId);
  const activeSheet = ss.setActiveSheet(ss.getSheets()[0]);
  data = activeSheet.getDataRange();
  values = data.getValues();

  let otItemNumberArr = [];
  values.forEach((val) => {
    if (val[1] != "") {
      otItemNumberArr.push(val[1]);
    }
  })

  for (i = 1; i < otItemNumberArr.length; i++) {
    if (activeSheet.getRange("E" + (i + 1)).getValue() != "") {
      activeSheet.getRange("E" + (i + 1)).setValue("");
    }
  }

  let returnedOrderFormsItemsQtyNeededArr = getOrderFormsTotalQtyNeeded(gradeLevel);
  Logger.log(`Updating Order Totals Google sheet for grade level ${gradeLevel}.`)

  let orderFormsItemNumberArr = returnedOrderFormsItemsQtyNeededArr[0];
  let orderFormsTotalQtyNeededArr = returnedOrderFormsItemsQtyNeededArr[1];

  for (let i = 0; i < orderFormsItemNumberArr.length; i++) {
    orderedItemFoundOnTotalsForm = false;

    for (let j = 0; j < otItemNumberArr.length; j++) {
      if (orderFormsItemNumberArr[i] == otItemNumberArr[j]) {

        currentTotalRequested = activeSheet.getRange("E" + (j + 1)).getValue();
        activeSheet.getRange("E" + (j + 1)).setValue(orderFormsTotalQtyNeededArr[i] + currentTotalRequested);
        orderedItemFoundOnTotalsForm = true;
        break;
      }
    } // inner for loop

    if (orderedItemFoundOnTotalsForm == false) {
      Logger.log("Ordered item not found on Order Totals form " + orderFormsItemNumberArr[i]);
    }

  } //outer for loop

} // end of function

function testIt() {

  let orderFormFolderNameArr = [
    "Kindergarten",
    "1st Grade",
    "2nd Grade",
    "3rd Grade",
    "4th Grade",
    "5th Grade"
  ];

  let orderFormFolderIdArr = [];

  orderFormFolderNameArr.forEach((val) => {
    orderFormFolderIdArr.push(folderId = DriveApp.getFoldersByName(val).next().getId());
  })

  Logger.log("orderFormFolderIdArr: " + orderFormFolderIdArr);

  // let folderId = DriveApp.getFoldersByName("1st Grade").next().getId();
  // Logger.log("folderId: " + folderId);

}




